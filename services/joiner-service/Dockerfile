# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Joiner Service Image â€“ Alpine + Node 23 (Monorepo Multi-Stage Build, Apr 2025)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

### â”€â”€ Stage 1: Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM node:23-alpine AS builder

# 1ï¸âƒ£ Set root working directory
WORKDIR /app

# 2ï¸âƒ£ Copy ALL package.json files (including shared if they exist)
COPY package*.json ./
COPY services/joiner-service/package*.json ./services/joiner-service/
COPY shared/package*.json ./shared/  

# 3ï¸âƒ£ Install root dependencies and service dependencies
RUN npm ci --omit=dev --workspace=services/joiner-service

# 4ï¸âƒ£ Copy service source
COPY services/joiner-service/ ./services/joiner-service/

# 5ï¸âƒ£ Copy shared code
COPY shared/ ./shared/


### â”€â”€ Stage 2: Runtime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM node:23-alpine

# 6ï¸âƒ£ Set service working directory
WORKDIR /app/services/joiner-service

# 7ï¸âƒ£ Bring in installed deps from builder
COPY --from=builder /app/node_modules ./node_modules

# 8ï¸âƒ£ Copy service source
COPY --from=builder /app/services/joiner-service/ ./

# 9ï¸âƒ£ Copy shared code
COPY --from=builder /app/shared/ /app/shared/

# ğŸ”§ Expose port from JOINER_PORT (default 4002)
EXPOSE 4002

# ğŸš€ Start the service
CMD ["node", "src/server.js"]